@{
    ViewBag.Title = "Details";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@using System.Globalization
@using Project_LTW;


<style>
    .page-spacer {
        margin-top: 120px; /* Bạn có thể tăng số này lên nếu vẫn bị dính (vd: 50px) */
    }

    .product-gallery {
        position: relative;
    }

    .main-image-container {
        border-radius: 10px;
        overflow: hidden;
        margin-bottom: 15px;
    }

    #mainImage {
        width: 100%;
        max-width: 400px;
        height: auto;
        border-radius: 10px;
        transition: transform 0.3s ease;
    }

        #mainImage:hover {
            transform: scale(1.02);
        }

    .thumbnails {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        justify-content: center;
    }

    .img-thumbnail {
        width: 70px;
        height: 70px;
        object-fit: cover;
        cursor: pointer;
        border-radius: 8px;
        border: 2px solid #ddd;
        transition: all 0.3s ease;
    }

        .img-thumbnail.active-thumb {
            border: 3px solid #28a745;
            transform: scale(1.1);
        }

        .img-thumbnail:hover {
            border-color: #28a745;
            transform: scale(1.05);
        }

    .color-options, .size-options {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 10px;
    }

    .color-btn, .size-btn {
        padding: 10px 20px;
        border: 2px solid #343a40;
        border-radius: 8px;
        background: #fff;
        color: #343a40;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        min-width: 80px;
        text-align: center;
    }

        .color-btn:hover, .size-btn:hover {
            background: #343a40;
            color: #fff;
            transform: translateY(-2px);
        }

        .color-btn.active, .size-btn.active {
            background: #343a40;
            color: #fff;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(52, 58, 64, 0.3);
        }

    .card {
        border: none;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        transition: all 0.3s ease;
    }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

    .card-img-top {
        height: 200px;
        object-fit: cover;
        border-radius: 12px 12px 0 0;
    }
</style>

@using (Html.BeginForm("AddtoCart", "Cart", FormMethod.Post))
{

    @* Hidden Fields để truyền Màu và Size: name="mau" và name="size" *@
    @Html.Hidden("mau", "", new { id = "selectedColor" })
    @Html.Hidden("size", "", new { id = "selectedSize" })
    <input type="hidden" name="sanPhamID" value="@Model.SANPHAMID.Trim()" />

    <div class="row mt-4">
        <div class="col-md-4">
            <div class="product-gallery">
                <div class="main-image-container">
                    <img id="mainImage" src="@Url.Content("~/assets/" + Model.HINHANHDAIDIEN)" alt="@Model.TENSANPHAM">
                </div>
                <div class="thumbnails mt-3">
                    <img class="img-thumbnail active-thumb" src="@Url.Content("~/assets/" + Model.HINHANHDAIDIEN)" data-full-src="@Url.Content("~/assets/" + Model.HINHANHDAIDIEN)" data-color="default" alt="@Model.TENSANPHAM">
                    @foreach (var img in Model.PRODUCT_IMAGE)
                    {
                        <img class="img-thumbnail" src="@Url.Content("~/assets/" + img.TENHINH)" data-full-src="@Url.Content("~/assets/" + img.TENHINH)" data-color="@img.MAUSAC" alt="@img.MAUSAC">
                    }
                </div>
            </div>
        </div>

        <div class="col-md-8">
            <h3 class="fw-bold">@Model.TENSANPHAM</h3>
            <h4 class="text-danger fw-bold">@Model.GIA.ToString("N0", new CultureInfo("vi-VN")) VNĐ</h4>
            <p class="text-muted">@Model.MOTA</p>

            <div class="mb-3 mt-4">
                <h5 class="fw-bold">Màu sắc:</h5>
                <div class="color-options">
                    @foreach (var color in Model.PRODUCT_COLOR)
                    {
                        <div type="button" class="btn color-btn" data-color="@color.MAUSAC">@color.MAUSAC</div>
                    }
                </div>
                <small class="text-danger d-none" id="colorError">Vui lòng chọn màu sắc</small>
            </div>

            <div class="mb-3">
                <h5 class="fw-bold">Size:</h5>
                <div class="size-options">
                    @foreach (var size in Model.PRODUCT_SIZE)
                    {
                        <div type="button" class="btn size-btn" data-size="@size.SIZE">@size.SIZE</div>
                    }
                </div>
                <small class="text-danger d-none" id="sizeError">Vui lòng chọn size</small>
            </div>

            <div class="mb-3 mt-4">
                <button type="submit" class="btn btn-success px-4 me-2">Thêm vào giỏ</button>
                <a href="@Url.Action("Index", "Home")" class="btn btn-outline-secondary px-4">Quay lại</a>
            </div>
        </div>
    </div>
}

<div class="mt-5">
    <h5 class="fw-bold mb-4">Sản phẩm liên quan</h5>
    <div class="row">
        @foreach (var item in ViewBag.SanPhamLienQuan as List<Project_LTW.PRODUCT>)
        {
            <div class="col-md-3 mb-4">
                <div class="card h-100 shadow-sm">
                    <img src="@Url.Content("~/assets/" + item.HINHANHDAIDIEN)" class="card-img-top" alt="@item.TENSANPHAM">
                    <div class="card-body text-center">
                        <h6 class="card-title fw-bold">@item.TENSANPHAM</h6>
                        <p class="text-danger fw-bold">@item.GIA.ToString("N0", new CultureInfo("vi-VN")) VNĐ</p>
                        <a href="@Url.Action("Details", "Home", new { id = item.SANPHAMID.Trim() })" class="btn btn-sm btn-outline-primary">Xem chi tiết</a>
                    </div>
                </div>
            </div>
        }
    </div>
</div>


@section Scripts {
    <script>
        $(document).ready(function () {
            console.log("jQuery đã chạy!");

            // 1. Xử lý click thumbnail
            $('.thumbnails').on("click", ".img-thumbnail", function () {
                var newImageSrc = $(this).data("full-src");
                $("#mainImage").attr("src", newImageSrc);
                $(".img-thumbnail").removeClass("active-thumb");
                $(this).addClass("active-thumb");
            });

            // 2. Xử lý chọn màu
            $(document).on('click', '.color-btn', function () {
                var selectedColor = $(this).data('color');
                console.log("Đã chọn màu:", selectedColor);

                $('.color-btn').removeClass('active');
                $(this).addClass('active');
                // Gán giá trị vào Hidden Field
                $('#selectedColor').val(selectedColor);
                $('#colorError').addClass('d-none');

                // Tìm ảnh thumbnail tương ứng màu để click
                var $matchingThumbnail = $('.img-thumbnail[data-color="' + selectedColor + '"]');
                if ($matchingThumbnail.length > 0) {
                    $matchingThumbnail.first().click();
                }
            });

            // 3. Xử lý chọn size
            $(document).on('click', '.size-btn', function () {
                var selectedSize = $(this).data('size');

                $('.size-btn').removeClass('active');
                $(this).addClass('active');
                // Gán giá trị vào Hidden Field
                $('#selectedSize').val(selectedSize);
                $('#sizeError').addClass('d-none');
            });

            // 4. Validate form
            $('form').on('submit', function (e) {
                var hasError = false;
                if (!$('#selectedColor').val()) {
                    $('#colorError').removeClass('d-none');
                    hasError = true;
                }
                if (!$('#selectedSize').val()) {
                    $('#sizeError').removeClass('d-none');
                    hasError = true;
                }
                if (hasError) {
                    e.preventDefault();
                    $('html, body').animate({
                        scrollTop: $('.color-options').offset().top - 150
                    }, 500);
                }
            });

            // 5. Tự động chọn option đầu tiên (Đảm bảo gán giá trị và hiệu ứng)

            // Xử lý Màu sắc
            if ($('.color-btn').length > 0) {
                var firstColorBtn = $('.color-btn').first();
                var firstColorValue = firstColorBtn.data('color');

                // Gán giá trị vào Hidden Field
                $('#selectedColor').val(firstColorValue);

                // Kích hoạt hiệu ứng Active cho nút đầu tiên
                firstColorBtn.addClass('active');

                // Tự động chọn ảnh thumbnail đại diện theo màu đầu tiên (nếu có)
                $('.img-thumbnail[data-color="' + firstColorValue + '"]').first().click();
            } else {
                // Nếu không có màu nào, gán giá trị rỗng để validate hoặc xử lý mặc định
                $('#selectedColor').val('');
            }

            // Xử lý Size
            if ($('.size-btn').length > 0) {
                var firstSizeBtn = $('.size-btn').first();
                var firstSizeValue = firstSizeBtn.data('size');

                // Gán giá trị vào Hidden Field
                $('#selectedSize').val(firstSizeValue);

                // Kích hoạt hiệu ứng Active cho nút đầu tiên
                firstSizeBtn.addClass('active');
            } else {
                // Nếu không có size nào, gán giá trị rỗng để validate hoặc xử lý mặc định
                $('#selectedSize').val('');
            }

        });
    </script>
}



