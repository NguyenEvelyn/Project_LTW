@model IEnumerable<Project_LTW.Models.TopKhachHang>

@{
    ViewBag.Title = "Báo cáo thống kê";
    Layout = "~/Areas/Admin/Views/Shared/_LayoutAdmin.cshtml";

    string dataStr = ViewBag.ChartData as string;
}

<!-- ✅ THÊM: CDN Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<div class="container-fluid">
    <h3 class="text-dark fw-bold mb-4">BÁO CÁO KINH DOANH NĂM @ViewBag.Nam</h3>

    <!-- Thẻ thống kê tổng quan -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card text-white bg-success shadow">
                <div class="card-body">
                    <h5><i class="bi bi-cash-stack"></i> Tổng Doanh thu</h5>
                    <h2 class="fw-bold">@String.Format("{0:N0}", ViewBag.TongDoanhThu) đ</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-white bg-info shadow">
                <div class="card-body">
                    <h5><i class="bi bi-cart-check"></i> Tổng Đơn hàng</h5>
                    <h2 class="fw-bold">@ViewBag.TongDonHang</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-white bg-warning shadow">
                <div class="card-body">
                    <h5><i class="bi bi-people"></i> Tổng Khách hàng</h5>
                    <h2 class="fw-bold">@ViewBag.TongKhachHang</h2>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- ✅ Biểu đồ -->
        <div class="col-md-7 mb-4">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h6 class="m-0 fw-bold"><i class="bi bi-bar-chart-fill me-2"></i>Biểu đồ Doanh thu</h6>
                </div>
                <div class="card-body">
                    <canvas id="myRevenueChart" style="max-height: 400px;"></canvas>
                </div>
            </div>
        </div>

        <!-- Bảng doanh thu -->
        <div class="col-md-5 mb-4">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h6 class="m-0 fw-bold"><i class="bi bi-calendar-check me-2"></i>Doanh thu từng tháng</h6>
                </div>
                <div class="card-body p-0">
                    <table class="table table-hover table-bordered mb-0 text-center">
                        <thead class="table-light">
                            <tr>
                                <th>Tháng</th>
                                <th>Doanh thu (VNĐ)</th>
                                <th>Trạng thái</th>
                            </tr>
                        </thead>
                        <tbody>
                            @{
                                string[] arrDoanhThu = dataStr != null ? dataStr.Split(',') : new string[12];
                            }
                            @for (int i = 0; i < 12; i++)
                            {
                                decimal doanhThu = 0;
                                decimal.TryParse(arrDoanhThu[i], out doanhThu);

                                <tr>
                                    <td class="fw-bold">Tháng @(i + 1)</td>
                                    <td class="text-danger fw-bold">@doanhThu.ToString("N0") đ</td>
                                    <td>
                                        @if (doanhThu > 0)
                                        {
                                            <span class="badge bg-success">Có doanh thu</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-secondary">--</span>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Top Khách hàng (CHỈ HIỂN thị khách có đơn hoàn tất) -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header bg-warning text-dark">
                    <h6 class="m-0 fw-bold"><i class="bi bi-trophy me-2"></i>Top Khách hàng (Đã hoàn tất đơn)</h6>
                </div>
                <div class="card-body p-0">
                    <table class="table table-striped mb-0 align-middle">
                        <thead class="table-dark">
                            <tr>
                                <th>STT</th>
                                <th>Khách hàng</th>
                                <th class="text-center">Số đơn</th>
                                <th class="text-end">Tổng chi tiêu</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (Model != null && Model.Any())
                            {
                                int stt = 1;
                                foreach (var kh in Model.Take(10))
                                {
                                    <tr>
                                        <td class="fw-bold">@stt</td>
                                        <td>@kh.TenKhachHang</td>
                                        <td class="text-center">
                                            <span class="badge bg-info text-dark">@kh.SoDonHang</span>
                                        </td>
                                        <td class="text-end text-danger fw-bold">
                                            @string.Format("{0:N0}", kh.TongTienDaMua) đ
                                        </td>
                                    </tr>
                                    stt++;
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="4" class="text-center text-muted py-3">Chưa có khách hàng nào hoàn tất đơn hàng</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
                <div class="card-footer text-muted small text-center">
                    * Chỉ tính đơn hàng đã hoàn tất (Cursor trong SQL)
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ✅ Script vẽ biểu đồ -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Lấy dữ liệu từ ViewBag
        const rawData = '@Html.Raw(ViewBag.ChartData)';
        console.log("Raw Chart Data:", rawData);  // Debug

        const dataValues = rawData.split(',').map(Number);
        console.log("Parsed Data:", dataValues);  // Debug

        const ctx = document.getElementById("myRevenueChart").getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ["T1", "T2", "T3", "T4", "T5", "T6", "T7", "T8", "T9", "T10", "T11", "T12"],
                datasets: [{
                    label: 'Doanh thu (VND)',  // ✅ SỬA: Bỏ ký tự đặc biệt
                    data: dataValues,
                    backgroundColor: 'rgba(54, 162, 235, 0.6)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return new Intl.NumberFormat('vi-VN', {
                                    style: 'currency',
                                    currency: 'VND'
                                }).format(value);
                            }
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return 'Doanh thu: ' + new Intl.NumberFormat('vi-VN', {
                                    style: 'currency',
                                    currency: 'VND'
                                }).format(context.parsed.y);
                            }
                        }
                    },
                    legend: {
                        labels: {
                            font: {
                                family: 'Arial, sans-serif',  // ✅ SỬA: Font an toàn
                                size: 14
                            }
                        }
                    }
                }
            }
        });
    });
</script>